# Deploy Jenkins and perform image scanning with NeuVector Vulnerability Scanner plugin

## Resolution
The following is a walk-through on deploying Jenkins using Docker and performing image scanning with NeuVector Vulnerability Scanner plugin.

### Components:
- NeuVector Deployment
- Docker Engine - Community
- Jenkins
- Neuvector Jenkins Plugin

### Pre-Requisites:
- The NeuVector Controller REST API port exposed
    . How to expose NV REST API
- Docker installed

There are three ways to deploy Jenkins using Docker.

1. Docker Run
```
docker run -p 8088:8088 -p 50000:50000 -v /var/run/docker.sock:/var/run/docker.sock:ro -v /usr/bin/docker:/usr/bin/docker --name jenkins-node jenkins/jenkins:lts
```
2. Docker Persistent
Create a basic script (jenkins-install.sh) and execute with root privileges.

3. Docker-compose

The Jenkins UI should be accessible from http://<docker_host>:8088/.

- Select "install suggested plugins"
- Create admin user
- Search and install Neuvector Vulnerability Scanner Plugin from Dashboard > Manage Jenkins > Manage plugins > Available
- Configure the plugin in Dashboard > Manage Jenkins > Configure System > NeuVector Vulnerability Scanner
    . REST API port exposed by default on 10443
- Registry setting is optional for local scan
- Create Pipeline from Dashboard > New Item > Pipeline
- Select and configure the new pipeline.  Add a NeuVector Scan stage into the pipeline.  See below on using the Pipeline Syntax to generate the scan stage script.

(Optional) Click on the "Pipeline Syntax" and choose the "neuvector: NeuVector Vulnerability Scanner" Sample Step.
Paste the generated code inside the steps braces for the 'Test NV Scan Images' stage.  In the following example, the repository and tag are replaced by a global variables defined under the environment section.
Run the job and review the artifact file generated by Neuvector Plugin with the analysis report.
Note: If we want to scan images using the digest hash, replace the tag value with the specific sha256 digest.
Registry scan results are available from the NeuVector WebUI under Notifications.
Note: For Kubernetes clusters, admission control rules will apply for these registry image scan results.
Local Image Scan
Create a new project with the following Build settings.  The registry value is Local.  The docker command relies on the volume mounts from the Jenkins container initialization (see above).
NOTE: For a local scan to work the scanner must be running along side Jenkins on the same host.
